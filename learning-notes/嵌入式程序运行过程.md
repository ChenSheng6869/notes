# 1 程序的运行过程解析

​	主要学习CPU\硬件等工作机制流程。

## 1.1 硬件启动流程

​	**程序以二进制码的形式存在FLASH中。**

> 1. 上电，系统从装有启动代码的Nor Flash启动后，初始化对应的硬件
>
> 2. CPU通过控制器将待运行的程序从FLASH读入内存
>
> 3. 代码在内存运行时，控制器将需要计算的数据存入寄存器中
> 4. 运算器从寄存器中读取数据进行运算，将结果存入寄存器中
> 5. 控制器将寄存器中的结果读入内存中

## 1.2 例程说明

​	系统开始运行时，程序在FLASH中，分为3个段，代码段、数据段、BSS段，控制器读取到CPU内部通用寄存器，CPU的机制会在内存中给他们各自分好内存空间。

​	**代码段在上电后的执行过程：**

>1. CPU对内部的BOOT ROM进行直接读取并解析指令后初始化部分DDR，指令会自动在内存分配代码段；
>2. CPU上的Flash控制器将flash上的代码拷贝到内存的代码段，然后CPU读取并执行解析代码，在DDR的堆和栈中不断存取数据，再根据解析下一行或下几行的代码的要求，访问指定地址的空间，存放数据，由于处理数据，放入内存中运行时，会有在DDR中多出2部分（堆和栈）用来处理数据。

# 2 嵌入式设备上电到应用层的过程(Linux)

​	**1.上电，CPU运行**

>  设备上电CPU开始运行，CPU会从某一个固定的物理地址开始跑，物理地址一般为FLASH芯片的起始物理地址。FLASH芯片最初一段通常存放的是Bootloader，CPU会首先执行Bootloader的代码。

>  CPU怎么读取Flash上的数据？
>
> 对于两种FLASH，NOR FLASH和NAND FLASH。
>
> NOR FLASH可以直接在FLASH芯片上执行指令，CPU可以直接运行NOR FLASH上的指令。
>
> NAND FLASH 第一种是将FLASH控制器能够把NAND FLASH的前4K数据搬到4K的内部RAM中，设置CPU从这个内部的RAM起始地址开始启动执行。第二种FLASH控制器将NANDFLASH 的前4K数据的地址映射到系统总线的某个地址上，设定CPU从这个地址开始启动执行。两种方法都需要硬件完成。

**2.Bootloader对于开发板资源的初始化**

Bootloader分汇编和C代码两部分，汇编不压缩，C经过压缩

> Bootloader开始执行时，第一部分汇编代码负责初始化CPU、PLL（锁相环，用来统一整合时钟信号）、DDR、Cache等硬件，使CPU和内存可稳定运行，然后解压第二部分的Image，并拷贝到内存中执行。第二部分C代码完成串口、FLASH、网口等驱动的加载，构建一个shell环境接受用户输入。在整个Bootloader运行期间CPU的MMU没有被初始化，所有的地址访问都采用物理地址直接访问。

**3.Bootloader拷贝内核镜像，为内核的运行准备环境**

>  完成Bootloader初始化后，由代码中设定的内核区物理地址，Bootloader将内核区压缩后的Linux镜像拷贝到内存中并解压，同时准备内核的启动参数，如：console=ttyS0,115200 root=31:2 mtdparts=ar7100-nor0:196608(boot),835236(kernel),-(rootfs)，这里主要是把Bootloader里设置的MTD分区信息传递给内核，还有需要加载的根文件系统。最后跳转到内核入口开始运行。

**4.Linux内核对于其各个子系统的MMU的初始化**

> Linux内核代码开始执行，会先进行内核各个子系统初始化，并完成对MMU的初始化。MMU是CPU中的一个单元，它跟操作系统一起配合完成从虚拟地址到物理地址的转换。如果CPU带有MMU单元，则CPU执行单元发出的内存地址将被MMU截获，从CPU到MMU的地址称为虚拟地址，而MMU将这个地址翻译成另一个地址发到CPU芯片的外部地址引脚上，这个地址称为物理地址。在这个过程中Linux内核会维护页表结构，它保存着内核和进程的虚拟地址到物理地址的映射，而MMU则通过Linux内核页表去完成地址翻译和保护工作。

**5.内核挂载根文件系统**

> Linux内核会挂载根文件系统，要挂载的根文件系统是通过内核启动参数来获取的。这里有一个问题，根文件系统通常表示为一个Linux文件系统下的某个MTD设备，但在加载根文件系统前Linux还没有一个文件系统，那它怎样通过访问文件系统中的MTD设备来加载根文件系统呢？事实上，根文件系统的安装分为两个阶段，首先Linux内核会安装一个特殊的RootFS文件系统，该文件系统仅提供一个作为初始安装点的空目录，然后Linux内核再在空目录上安装一个真正的根目录。Linux内核对Flash的访问都是通过MTD子系统来进行的，它抽象了对于各种Flash设备的访问，提供统一的接口。

**6.内核对于各种驱动程序的初始化**

> Linux内核继续初始化各种类型的驱动程序，完成之后会启动第一个应用程序，它的进程ID为1。这个应用程序可以由内核启动参数传入，如果没有则会默认执行/sbin/init。init进程会读取配置文件/etc/inittab，根据配置文件的内容它会完成两个工作，执行rcS和启动Shell。至此，Linux系统已经启动完成，给用户提供了一个Shell的交互环境，后续的行为就取决于用户的输入或者系统特定应用的加载。

